name: Auto Release on Tag

# 触发条件：当推送 Tag 且 Tag 以 v 开头（如 v1.0.0）
on:
  push:
    tags:
      - 'v*'  # 匹配 v1.0.0、v2.1.1 等 Tag

# 关键：添加权限配置
permissions:
  contents: write  # 允许创建/修改 Release（属于仓库内容）

jobs:
  build-and-release:
    runs-on: ubuntu-latest  # 运行环境（可选 ubuntu/macos/windows）

    steps:
      # 创建 GitHub Release
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          

jobs:
  build:
    name: Build for Linux amd64
    runs-on: ubuntu-latest  # 用 Ubuntu 构建（兼容 Linux amd64）

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取完整历史，用于生成源码包

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'  # 项目使用的 Go 版本
          cache: true

      - name: Build Linux amd64 binary
        env:
          BIN_NAME: "myapp-linux-amd64"  # 固定文件名（明确架构）
        run: |
          # 构建 Linux amd64 二进制（启用 CGO 兼容系统库，可选）
          CGO_ENABLED=1 GOOS=linux GOARCH=amd64 go build -ldflags "-X main.version=${{ github.ref_name }}" -o "dist/${BIN_NAME}" main.go
          # 添加可执行权限
          chmod +x "dist/${BIN_NAME}"

      - name: Generate source archives
        run: |
          TAG_NAME="${{ github.ref_name }}"
          # 生成源码包（.tar.gz 和 .zip）
          git archive --format=tar.gz --output="dist/myapp-${TAG_NAME}.tar.gz" --prefix="myapp-${TAG_NAME}/" ${TAG_NAME}
          git archive --format=zip --output="dist/myapp-${TAG_NAME}.zip" --prefix="myapp-${TAG_NAME}/" ${TAG_NAME}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-amd64-artifacts
          path: dist/

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-amd64-artifacts
          path: dist/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Release ${{ github.ref_name }}"
          files: dist/*  # 上传 Linux amd64 二进制和源码包
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}