name: Auto Release on Tag

# 触发条件：当推送 Tag 且 Tag 以 v 开头（如 v1.0.0）
on:
  push:
    tags:
      - 'v*'  # 匹配 v1.0.0、v2.1.1 等 Tag

# 关键：添加权限配置
permissions:
  contents: write  # 允许创建/修改 Release（属于仓库内容）

jobs:
  build-and-release:
    runs-on: ubuntu-latest  # 运行环境（可选 ubuntu/macos/windows）

    steps:

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      # 步骤 1：构建二进制（输出到 cmd/ 目录）
      - name: Build binary
        run: |
          # 构建二进制到 cmd/ 目录
          go build -o bin/myapp main.go

      # 步骤 2：打包指定目录（cmd/ 和 conf/）
      - name: Package selected directories
        run: |
          TAG_NAME="${{ github.ref_name }}"
          # 创建输出目录
          mkdir -p dist
          # 打包 script/ 和 config/ 到 dist/ 目录，命名格式：myapp-{tag}-dirs.tar.gz
          tar -czf "dist/myapp-${TAG_NAME}-dirs.tar.gz" script/ config/

      # 步骤 3：创建 Release 并上传打包文件
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Release ${{ github.ref_name }}"
          files: |
            dist/*.tar.gz
            bin/myapp
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
